bone_config = {
	["WEAPON_BAT"] = {
		bone = 24818,
		coordinates = {x = -0.1, y = -0.15, z = 0.07},
		rotation = {x = 0.0, y = 125.0, z = 0.0},
		model = "w_me_bat"
	},
	["WEAPON_GOLFCLUB"] = {		
		bone = 24818,		
		coordinates = {x = -0.2, y = -0.15, z = 0.07},
		rotation = {x = 0.0, y = 90.0, z = 0.0},
		model = "w_me_gclub"
	},
	["WEAPON_CROWBAR"] = {
		bone = 24818,
		coordinates = {x = -0.2, y = -0.15, z = 0.07},
		rotation = {x = 0.0, y = 90.0, z = 0.0},
		model = "w_me_crowbar"
	},
	["WEAPON_HATCHET"] = {
		bone = 51826, 
		coordinates = {x = -0.01, y = 0.10, z = 0.1},
		rotation = {x = 85.0, y = 0.0,  z = 45.0},
		model = "w_me_hatchet"
	},
	["WEAPON_MACHETE"] = {
		bone = 51826,
		coordinates = {x = -0.01, y = 0.10, z = 0.1},
		rotation = {x = 85.0, y = 0.0,  z = 45.0},
		model = "prop_ld_w_me_machette"
	},
	["WEAPON_PETROLCAN"] = {
		bone = 24818,
		coordinates = {x = 0.1, y = -0.15, z = 0.0}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0},
		model = "w_am_jerrycan"
	},
	["WEAPON_PUMPSHOTGUN"] = {
		bone = 24818,		
		coordinates = {x = 0.1, y = -0.15, z = 0.0},
		rotation = {x = 0.0, y = 0.0, z = 0.0}, 
		model = "w_sg_pumpshotgun"
	}, 
	["WEAPON_MICROSMG"] = {
		bone = 24818,
		coordinates = {x = 0.1, y = -0.15, z = 0.0}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0},
		model = "w_sb_microsmg"
	},
	["WEAPON_GUSENBERG"] = {
		bone = 24818,
		coordinates = {x = 0.1, y = -0.15, z = 0.0}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0},
		model = "w_sb_gusenberg"},
	["WEAPON_COMBATPDW"] = {
		bone = 24818,
		coordinates = {x = 0.1, y = -0.15, z = 0.0}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0},
		model = "w_sb_combatpdw"
	},
	["WEAPON_MINISMG"] = {
		bone = 51826,
		coordinates = {x = -0.01, y = 0.10, z = 0.07},
		rotation = {x = -115.0, y = 0.0,  z = 0.0},
		model = "w_sb_minismg"
	},
	["WEAPON_CARBINERIFLE"] = {
		bone = 24818,
		coordinates = {x = 0.09, y = -0.15, z = 0.1}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0},
		model = "w_ar_carbinerifle"
	},
	["WEAPON_BULLPUPRIFLE"] = {
		bone = 24818,
		coordinates = {x = 0.09, y = -0.15, z = 0.1}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0},
		model = "w_ar_bullpuprifle"
	},
	["WEAPON_COMPACTRIFLE"] = {
		bone = 24818,
		coordinates = {x = 0.09, y = -0.15, z = 0.1}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0},
		model = "w_ar_compactrifle"
	},
	["WEAPON_SAWNOFFSHOTGUN"] = {
		bone = 24818,
		coordinates = {x = 0.1, y = -0.15, z = 0.0}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0},
		model = "w_sg_sawnoffshotgun"
	},
	["WEAPON_BULLPUPSHOTGUN"] = {
		bone = 24818,		
		coordinates = {x = 0.1, y = -0.15, z = 0.0}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0}, 
		model = "w_sg_bullpupshotgun"
	},
	["WEAPON_MUSKET"] = {
		bone = 24818,		
		coordinates = {x = 0.09, y = -0.15, z = 0.1}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0}, 
		model = "w_ar_musket"
	},
--[[	["WEAPON_DBSHOTGUN"] = {
		bone = 57597,		
		coordinates = {x = 0.08, y = -0.15, z = 0.07}, 
		rotation = {x = 0.0, y = 75.0, z = 0.0}, 
		model = "w_sg_doublebarrel"
	},--]]
	["WEAPON_SNIPERRIFLE"] = {
		bone = 24818,
		coordinates = {x = 0.1, y = -0.15, z = 0.0}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0},
		model = "w_sr_sniperrifle"
	},
	["WEAPON_HEAVYSNIPER"] = {
		bone = 24818,		
		coordinates = {x = 0.1, y = -0.15, z = 0.0}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0}, 
		model = "w_sr_heavysniper"
	},
	["WEAPON_MARKSMANRIFLE"] = {
		bone = 24818,		
		coordinates = {x = 0.1, y = -0.15, z = 0.0}, 
		rotation = {x = 0.0, y = 0.0, z = 0.0}, 
		model = "w_sr_marksmanrifle"
	},
	["WEAPON_BATTLEAXE"] = {
		bone = 24818,
		coordinates = {x = -0.1, y = -0.15, z = 0.07},
		rotation = {x = 0.0, y = 125.0, z = 0.0},
		model = "w_me_battleaxe"
	},
	["WEAPON_POOLCUE"] = {
		bone = 24818,
		coordinates = {x = -0.1, y = -0.15, z = 0.07},
		rotation = {x = 0.0, y = 125.0, z = 0.0},
		model = "w_me_poolcue"
	},
	["WEAPON_WRENCH"] = {
		bone = 51826,
		coordinates = {x = -0.01, y = 0.10, z = 0.08},
		rotation = {x = 90.0, y = 90.0,  z = 0.0},
		model = "w_me_wrench"
	},
}

local attached_weapons = {}
local aw_loaded = false
local firingdisabled = false
-----------------------------------------------------------
-----------------------------------------------------------
Citizen.CreateThread(function()
	while true do
		Citizen.Wait(0)
		if aw_loaded then
			local _ped = PlayerPedId()
			for _weapon, values in pairs(bone_config) do
				local _weapon_hash = GetHashKey(_weapon)
	    		if HasPedGotWeapon(_ped, _weapon_hash, false) then
	    			local onPlayer = false

					for _Weapon, entity in pairs(attached_weapons) do
	      				if entity ~= nil then
	      					if _Weapon == _weapon then
	      						onPlayer = true
	      						break
	      					end
	      				end
	      			end

	      			if not onPlayer and _weapon_hash ~= GetSelectedPedWeapon(_ped) then
		      			AddWeapon(_weapon)
	      			elseif onPlayer and _weapon_hash == GetSelectedPedWeapon(_ped) then
						RemoveWeapon(_weapon)
	      			end
	      		else
					for _Weapon, entity in pairs(attached_weapons) do
	      				if entity ~= nil then
	      					if _Weapon == _weapon then
	      						onPlayer = true
	      						break
	      					end
	      				end
	      			end

	      			if attached_weapons[_weapon] ~= nil then
	      				RemoveWeapon(_weapon)
	      			end
	    		end
	    	end
  		end
	end
end)
-----------------------------------------------------------
-----------------------------------------------------------
AddEventHandler("aw:load", function()
	print("Loading _weapons")
	aw_loaded = false
	RemoveAndAddWeapons()
end)

AddEventHandler("aw:remove", function()
	aw_loaded = false
	RemoveWeapons()
end)

function RemoveWeapon(_weapon)
	if attached_weapons[_weapon] ~= nil then
		DestroyObject(attached_weapons[_weapon])
	end
	attached_weapons[_weapon] = nil
end

function RemoveWeapons()
	for _weapon, entity in pairs(attached_weapons) do
		if entity ~= nil then
			DestroyObject(entity)
		end
	end
	attached_weapons = {}
end

function AddWeapon(_weapon)
	if bone_config[_weapon] then
		local weapon_hash = GetHashKey(bone_config[_weapon]["model"])
		RequestModel(weapon_hash)
		while not HasModelLoaded(weapon_hash) do
			Citizen.Wait(0)
		end

		attached_weapons[_weapon] = CreateObject(weapon_hash, x, y, z, true, false, false)

		while not DoesEntityExist(attached_weapons[_weapon]) do
			Citizen.Wait(0)
		end

		SetModelAsNoLongerNeeded(weapon_hash)

		local _ped = PlayerPedId()
		local boneIndex = GetPedBoneIndex(_ped, bone_config[_weapon]["bone"])
		local bonePos = GetWorldPositionOfEntityBone(_ped, boneIndex)
		AttachEntityToEntity(attached_weapons[_weapon], _ped, boneIndex, bone_config[_weapon]["coordinates"]["x"], bone_config[_weapon]["coordinates"]["y"], bone_config[_weapon]["coordinates"]["z"], bone_config[_weapon]["rotation"]["x"], bone_config[_weapon]["rotation"]["y"], bone_config[_weapon]["rotation"]["z"], false, false, false, false, 2, true)
		
	end
end

function AddWeapons()
	Citizen.CreateThread(function()
		for _weapon, values in pairs(user_weapons) do
			if bone_config[_weapon] then
				local weapon_hash = GetHashKey(bone_config[_weapon]["model"])
				RequestModel(weapon_hash)

				while not HasModelLoaded(weapon_hash) do
					Citizen.Wait(0)
				end
				attached_weapons[_weapon] = CreateObject(weapon_hash, x, y, z, true, false, false)
				while not DoesEntityExist(attached_weapons[_weapon]) do
					Citizen.Wait(0)
				end

				SetModelAsNoLongerNeeded(weapon_hash)

				local _ped = PlayerPedId()
				local boneIndex = GetPedBoneIndex(_ped, bone_config[_weapon]["bone"])
				local bonePos = GetWorldPositionOfEntityBone(_ped, boneIndex)
				AttachEntityToEntity(attached_weapons[_weapon], _ped, boneIndex, bone_config[_weapon]["coordinates"]["x"], bone_config[_weapon]["coordinates"]["y"], bone_config[_weapon]["coordinates"]["z"], bone_config[_weapon]["rotation"]["x"], bone_config[_weapon]["rotation"]["y"], bone_config[_weapon]["rotation"]["z"], false, false, false, false, 2, true)
				
			end
		end
	end)
end

function RemoveAndAddWeapons()
	Citizen.CreateThread(function()
		for _weapon, entity in pairs(attached_weapons) do
			if entity ~= nil then
				DestroyObject(entity)
			end
		end
		attached_weapons = {}
		for _weapon, values in pairs(bone_config) do
			local _weapon_hash = GetHashKey(_weapon)
	    	if HasPedGotWeapon(_ped, _weapon_hash, false) then
	    		local onPlayer = false

				for _Weapon, entity in pairs(attached_weapons) do
	      			if entity ~= nil then
	      				if _Weapon == _weapon then
	      					onPlayer = true
	      					break
	      				end
	      			end
	      		end

	      		if not onPlayer and _weapon_hash ~= GetSelectedPedWeapon(_ped) then
		      		AddWeapon(_weapon)
	      		elseif onPlayer and _weapon_hash == GetSelectedPedWeapon(_ped) then
					RemoveWeapon(_weapon)
	      		end
	      	else
	      		if attached_weapons[_weapon] ~= nil then
	      			RemoveWeapon(_weapon)
	      		end
	    	end
	    end
		aw_loaded = true
	end)
end

local weaponstable = {
    "WEAPON_PISTOL",
    "WEAPON_PISTOL50",
    "WEAPON_COMBATPISTOL",
    "WEAPON_STUNGUN",
    "WEAPON_FLAREGUN",
    "WEAPON_APPISTOL",
    "WEAPON_DBSHOTGUN",
    "WEAPON_MICROSMG",
    "WEAPON_PISTOL_MK2",
    "WEAPON_VINTAGEPISTOL",
}

local riflestable = {
    "WEAPON_CARBINERIFLE",
    "WEAPON_COMPACTRIFLE",
    "WEAPON_PUMPSHOTGUN",
    "WEAPON_MUSKET",
    "WEAPON_SAWNOFFSHOTGUN",
    "WEAPON_BAT",
    "WEAPON_GOLFCLUB",
    "WEAPON_POOLCUE",
}

function CheckWeapon(ped)
    for i = 1, #weaponstable do
        if GetHashKey(weaponstable[i]) == GetSelectedPedWeapon(ped) then
            return true
        end
    end
    return false
end

function CheckHeavyWeapon(ped)
    for i = 1, #riflestable do
        if GetHashKey(riflestable[i]) == GetSelectedPedWeapon(ped) then
            return true
        end
    end
    return false
end

local holstered = nil
local holstered2 = nil
Citizen.CreateThread(function()
    while true do
        Citizen.Wait(0)
        local ped = PlayerPedId()
        if DoesEntityExist( ped ) and not IsEntityDead( ped ) and not IsPedInAnyVehicle(PlayerPedId(), true)then
            RequestAnimDict( "reaction@intimidation@1h" )
            RequestAnimDict( "rcmjosh4" )
            RequestAnimDict( "weapons@pistol@" )
            RequestAnimDict( "anim@heists@money_grab@duffel" )
        	if(exports.policejob:getIsInService() or GetSelectedPedWeapon(ped) == GetHashKey("WEAPON_MICROSMG") ) then
        		if CheckWeapon(ped) then
            		if holstered then
                		TaskPlayAnim(ped, "rcmjosh4", "josh_leadout_cop2", 8.0, 2.0, -1, 48, 10, 0, 0, 0 )
						firingdisabled = true
                		Citizen.Wait(400)
                		
                		ClearPedTasks(ped)
                		holstered = false
                		firingdisabled = false
            		end
            	else
	                if not holstered then
		                SetPedCurrentWeaponVisible(ped, 1, 1, 1, 1)
		                TaskPlayAnim(ped, "weapons@pistol@", "aim_2_holster", 8.0, 2.0, -1, 48, 10, 0, 0, 0 )
						firingdisabled = true
		                Citizen.Wait(1200)
		                
		                ClearPedTasks(ped)
		                holstered = true
		                firingdisabled = false
        			end
        		end
        		if CheckHeavyWeapon(ped) then
            		if holstered2 then
                		TaskPlayAnim(ped, "anim@heists@money_grab@duffel", "enter", 8.0, 2.0, -1, 48, 10, 0, 0, 0 )
						firingdisabled = true
                		Citizen.Wait(1200)
                		
                		ClearPedTasks(ped)
                		holstered2 = false
                		firingdisabled = false
            		end
            	else
	                if not holstered2 then
		                TaskPlayAnim(ped, "anim@heists@money_grab@duffel", "enter", 8.0, 2.0, -1, 48, 10, 0, 0, 0 )
						firingdisabled = true
		                Citizen.Wait(1200)
		                
		                ClearPedTasks(ped)
		                holstered2 = true
		                firingdisabled = false
        			end
        		end
        	else
        		if CheckWeapon(ped) then
	                if holstered then
	                    SetPedCurrentWeaponVisible(ped, 0, 1, 1, 1)
	                    TaskPlayAnim(ped, "reaction@intimidation@1h", "intro", 8.0, 2.0, -1, 48, 10, 0, 0, 0 )
						firingdisabled = true
	                    Citizen.Wait(1100)
	                    SetPedCurrentWeaponVisible(ped, 1, 1, 1, 1)
	                    Citizen.Wait(1200)
	                    
	                    ClearPedTasks(ped)
	                    holstered = false
	                    firingdisabled = false
	                end
	            else
	                if not holstered then
	                    SetPedCurrentWeaponVisible(ped, 1, 1, 1, 1)
	                    TaskPlayAnim(ped, "reaction@intimidation@1h", "outro", 8.0, 2.0, -1, 48, 10, 0, 0, 0 )
						firingdisabled = true
	                    Citizen.Wait(1300)
	                    
	                    ClearPedTasks(ped)
	                    holstered = true
	                    firingdisabled = false
	                end
	            end
	            if CheckHeavyWeapon(ped) then
            		if holstered2 then
                		TaskPlayAnim(ped, "anim@heists@money_grab@duffel", "enter", 8.0, 2.0, -1, 48, 10, 0, 0, 0 )
						firingdisabled = true
                		Citizen.Wait(1200)
                		
                		ClearPedTasks(ped)
                		holstered2 = false
                		firingdisabled = false
            		end
            	else
	                if not holstered2 then
		                TaskPlayAnim(ped, "anim@heists@money_grab@duffel", "enter", 8.0, 2.0, -1, 48, 10, 0, 0, 0 )
						firingdisabled = true
		                Citizen.Wait(1200)
		                
		                ClearPedTasks(ped)
		                holstered2 = true
		                firingdisabled = false
        			end
        		end
            end
        end
    end
end)

Citizen.CreateThread(function()
	while true do
		Citizen.Wait(0)
		if firingdisabled then
			DisablePlayerFiring(PlayerPedId(), true)
            DisableControlAction(0, 140, true)
			DisableControlAction(0, 141, true)
			DisableControlAction(0, 142, true)
			DisableControlAction(0, 37, true) -- Disables INPUT_SELECT_WEAPON (TAB)
		end
	end
end)